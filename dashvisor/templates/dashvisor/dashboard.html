{% extends 'dashvisor/base.html' %}
{% load static %}
{% block content %}
    <div class="container-fluid p-4">
        <table id="supervisor" class="table table-striped table-condensed" style="width:100%">
            <thead>
                <tr>
                    <th>Server ID</th>
                    <th>Server</th>
                    <th>Process Name</th>
                    <th>Process State</th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
        </table>
    </div>
{% include 'dashvisor/modal.html' %}
{% endblock %}
{% block javascript %}
    {{ block.super }}
    <script type="application/javascript" src="{% static 'dashvisor/js/supervisor.js' %}"></script>
    <script type="application/javascript">
    </script>
    <script type="application/javascript">
        $(document).ready(function () {
            var control_url = '{{ base_path }}control/';
            var action_index = 4;
            $('#supervisor').DataTable({
                processing: true,
                serverSide: false,
                "initComplete": function( settings, json ) {
                    $("button.action").supervisor({
                        url: control_url
                    }).action();

                    $("a.tail").supervisor({
                        url: control_url,
                        screen: $('#supervisor-modal')
                    }).action()
                },
                ajax: {
                    url: "{{ query_url }}",
                    data: function (data) {
                        $.extend(data, {
                            'server': 'publique',
                            'action': 'refresh'
                        });
                        return data
                    }
                },
                columns: [
                    {"data": "server.id"},
                    {"data": "server.name"},
                    {"data": "name"},
                    {"data": 'statename'},
                ],
                columnDefs: [
                    { "visible": false,  "targets": 0 },
                    {
                        "render": function ( data, type, row ) {
                            return '<a href="#" class="tail" data-action="tail" data-toggle="tooltip"' +
                                'title="'+ row.human_name + '"' +
                                'data-server="' + row.server.id + '"' +
                                'data-process="' + row.id + '">' + data +
                                '</a>'
                        },
                        "targets": 2
                    },
                    {
                        "render": function ( data, type, row ) {
                            var state = {"RUNNING": 'primary', 'STOPPED': 'danger', 'STARTING': 'warning'};
                            return '<p class="text-' + state[data] + '">' + data + '</p>'
                        },
                        "targets": 3
                    },
                    {
                        "render": function ( data, type, row ) {
                            return "<button data-action='start' data-server='" + row.server.id + "' data-process='" + row.id + "' class='btn btn-primary action'>Start</button>"
                        },
                        "targets": action_index
                    },
                    {
                        "render": function ( data, type, row ) {
                            return "<button data-action='stop' data-server='" + row.server.id + "' data-process='" + row.id + "'class='btn btn-danger action'>Stop</button>"
                        },
                        "targets": action_index + 1
                    },
                    {
                        "render": function ( data, type, row ) {
                            return "<button data-action='restart' data-server='" + row.server.id + "' data-process='" + row.id + "'class='btn btn-warning action'>Restart</button>"
                        },
                        "targets": action_index + 2
                    },
                ]
            });
        });
    </script>
{% endblock %}